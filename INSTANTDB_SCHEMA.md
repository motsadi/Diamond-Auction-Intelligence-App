# InstantDB Schema Definition

This document describes the InstantDB schema used by the Diamond Auction Intelligence platform.

## Collections

### users

Stores user accounts with authentication and role information.

| Field | Type | Description |
|-------|------|-------------|
| id | string | Unique user ID (auto-generated by InstantDB) |
| email | string | User email address (unique) |
| role | string | User role: "user" or "admin" |
| createdAt | number | Timestamp in milliseconds |

**Permissions:**
- Users can read their own record
- Users can update their own email (if needed)
- Admins can read all user records

### datasets

Stores metadata about uploaded datasets.

| Field | Type | Description |
|-------|------|-------------|
| id | string | Unique dataset ID (UUID) |
| ownerId | string | User ID who owns the dataset |
| name | string | Dataset name |
| createdAt | number | Timestamp in milliseconds |
| gcsBucket | string | GCS bucket name |
| gcsObject | string | GCS object path |
| rowCount | number | Number of rows in the dataset |
| columns | array<string> | List of column names |
| notes | string? | Optional notes about the dataset |

**Permissions:**
- Users can read/write their own datasets only
- `ownerId == auth.id` for read/write access

### predictions

Stores prediction run results and metadata.

| Field | Type | Description |
|-------|------|-------------|
| id | string | Unique prediction ID (UUID) |
| ownerId | string | User ID who owns the prediction |
| datasetId | string | ID of the dataset used |
| modelName | string | Name of the model used (e.g., "Gradient Boosting") |
| horizon | number? | Optional forecast horizon |
| createdAt | number | Timestamp in milliseconds |
| metrics | object? | Prediction metrics: `{price_r2, price_mae, sale_accuracy}` |
| outputGcsObject | string? | GCS path to output CSV |
| previewRows | array<object>? | Preview of prediction results (first 10 rows) |

**Permissions:**
- Users can read/write their own predictions only
- `ownerId == auth.id` for read/write access

### models

Model registry (admin-managed).

| Field | Type | Description |
|-------|------|-------------|
| id | string | Unique model ID |
| name | string | Model name (e.g., "Gradient Boosting") |
| version | string | Model version |
| description | string? | Model description |
| features | array<string> | List of feature names used |
| createdAt | number | Timestamp in milliseconds |

**Permissions:**
- All users can read models
- Only admins can create/update/delete models
- `auth.role == 'admin'` for write access

### audit_logs

Audit trail of system actions (admin-only).

| Field | Type | Description |
|-------|------|-------------|
| id | string | Unique log ID |
| actorId | string | User ID who performed the action |
| action | string | Action name (e.g., "dataset.upload", "prediction.run") |
| entityType | string | Type of entity (e.g., "dataset", "prediction") |
| entityId | string | ID of the affected entity |
| createdAt | number | Timestamp in milliseconds |
| meta | object? | Additional metadata about the action |

**Permissions:**
- Only admins can read audit logs
- System can write audit logs (via API with service account)
- `auth.role == 'admin'` for read access

## Permission Rules (JSON Format)

Example permission configuration for InstantDB:

```json
{
  "users": {
    "read": "id == auth.id || auth.role == 'admin'",
    "write": "id == auth.id"
  },
  "datasets": {
    "read": "ownerId == auth.id",
    "write": "ownerId == auth.id"
  },
  "predictions": {
    "read": "ownerId == auth.id",
    "write": "ownerId == auth.id"
  },
  "models": {
    "read": "true",
    "write": "auth.role == 'admin'"
  },
  "audit_logs": {
    "read": "auth.role == 'admin'",
    "write": "true"  // System writes via API
  }
}
```

## Bootstrap Admin User

After creating your first user account through the app:

1. Go to InstantDB console
2. Find the user record by email
3. Update the `role` field to `"admin"`

Or use InstantDB's API:

```javascript
// Example using InstantDB client
await db.transact(
  db.tx.users[userId].update({ role: 'admin' })
);
```

## Indexes

Recommended indexes for performance:

- `datasets.ownerId` - For querying user's datasets
- `predictions.ownerId` - For querying user's predictions
- `predictions.datasetId` - For querying predictions by dataset
- `audit_logs.createdAt` - For sorting audit logs by time










